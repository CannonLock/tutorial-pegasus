#!/bin/bash

set -e

TOPDIR=`pwd`

# use the latest Pegasus development version
export PATH=/cvmfs/oasis.opensciencegrid.org/osg/projects/pegasus/rhel7/4.9.0dev/bin:$PATH

# stashcache is used for data transfers
module load stashcache

# a good working directory
export WORK_DIR=/local-scratch/$USER/workflows
mkdir -p $WORK_DIR

# generate the dax
export PYTHONPATH=`pegasus-config --python`
./dax-generator.py

# create the site catalog from the template
envsubst < "sites.xml.template" > "sites.xml"

# plan and submit the  workflow
pegasus-plan \
    --conf pegasus.conf \
    --dir $WORK_DIR/runs \
    --relative-dir `date +'%s'` \
    --sites condorpool \
    --staging-site stash \
    --output-site local \
    --dax dax.xml \
    --cluster horizontal \
    --submit

